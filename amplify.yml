version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - npm ci || npm install
    build:
      commands:
        - export NEXT_TELEMETRY_DISABLED=1
        - npm run build
        - echo "Next.js SSR build completed"
        - echo "=== Checking .next directory ==="
        - ls -la .next/
        - echo "=== Checking for required-server-files.json ==="
        - if [ -f .next/required-server-files.json ]; then echo "✅ required-server-files.json EXISTS"; cat .next/required-server-files.json | head -20; else echo "❌ required-server-files.json NOT FOUND"; fi
        - echo "=== Current directory structure ==="
        - find . -name "required-server-files.json" -type f
        - echo "=== All .json files in .next ==="
        - find .next -name "*.json" -type f
        - echo "=== Ensuring required-server-files.json is accessible ==="
        - if [ -f .next/required-server-files.json ]; then cp .next/required-server-files.json ./required-server-files.json; echo "Copied to root"; fi
        - echo "=== Final check ==="
        - ls -la | grep required-server-files || echo "No required-server-files.json in root"
        - echo "=== Checking for server trace files ==="
        - find .next -name "*.nft.json" | head -10
        - echo "=== Checking standalone directory ==="
        - ls -la .next/standalone/ | head -10
        - echo "=== Copying public assets to standalone ==="
        - cp -r public .next/standalone/
        - echo "=== Copying required-server-files.json to standalone root ==="
        - cp .next/standalone/.next/required-server-files.json .next/standalone/required-server-files.json
        - echo "=== Creating server trace files structure in standalone ==="
        - mkdir -p .next/standalone/server/pages/services
        - echo "=== Copying individual nft.json files ==="
        - find .next/standalone/.next/server/pages -name "*.nft.json" -not -path "*/services/*" -exec cp {} .next/standalone/server/pages/ \;
        - find .next/standalone/.next/server/pages/services -name "*.nft.json" -exec cp {} .next/standalone/server/pages/services/ \; 2>/dev/null || true
        - echo "=== Copying server directory structure ==="
        - cp -r .next/standalone/.next/server .next/standalone/ || true
        - echo "=== Copying other required server files ==="
        - cp .next/standalone/.next/routes-manifest.json .next/standalone/ || true
        - cp .next/standalone/.next/prerender-manifest.json .next/standalone/ || true
        - echo "=== Creating root-level server files for Amplify ==="
        - cp -r .next/standalone/server . || true
        - cp .next/standalone/required-server-files.json . || true
        - cp .next/standalone/.next/routes-manifest.json . || true
        - cp .next/standalone/.next/prerender-manifest.json . || true
        - echo "=== Final standalone structure ==="
        - ls -la .next/standalone/
        - echo "=== Verifying required-server-files.json in standalone ==="
        - ls -la .next/standalone/ | grep required-server-files || echo "No required-server-files.json in standalone root"
        - echo "=== Verifying server trace files in standalone ==="
        - find .next/standalone -name "*.nft.json" | head -10
        - echo "=== Complete standalone structure ==="
        - find .next/standalone -type f -name "*.json" | grep -E "(nft|required-server-files|routes-manifest|prerender-manifest)" | head -20
        - echo "=== Root-level files for Amplify ==="
        - ls -la | grep -E "(required-server-files|routes-manifest|prerender-manifest)" || echo "No root-level files found"
        - echo "=== Root-level server directory ==="
        - ls -la server/ | head -10 || echo "No root-level server directory found"
  artifacts:
    baseDirectory: .
    files:
      - '.next/standalone/**/*'
      - 'server/**/*'
      - 'required-server-files.json'
      - 'routes-manifest.json'
      - 'prerender-manifest.json'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*